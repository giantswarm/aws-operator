AWSTemplateFormatVersion: 2010-09-09
Description: Tenant Cluster Control Plane Cloud Formation Stack.
Outputs:
  DockerVolumeResourceName:
    Value: DockerVolume8Y5CK78968
  HostedZoneNameServers:
    Value: !Join [ ',', !GetAtt 'HostedZone.NameServers' ]
  OperatorVersion:
    Value: 7.3.0
  VPCID:
    Value: !Ref VPC
  VPCPeeringConnectionID:
    Value: !Ref VPCPeeringConnection
Resources:
  IAMManagerRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: 8y5ck-IAMManager-Role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          Effect: "Allow"
          Principal:
            AWS: !GetAtt MasterRole.Arn
          Action: "sts:AssumeRole"
  IAMManagerRolePolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: 8y5ck-IAMManager-Policy
      Roles:
        - Ref: "IAMManagerRole"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          Effect: "Allow"
          Action: "sts:AssumeRole"
          Resource: "*"
  Route53ManagerRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: 8y5ck-Route53Manager-Role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          Effect: "Allow"
          Principal:
            AWS: !GetAtt IAMManagerRole.Arn
          Action: "sts:AssumeRole"
  Route53ManagerRolePolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: 8y5ck-Route53Manager-Policy
      Roles:
        - Ref: "Route53ManagerRole"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action: "route53:ChangeResourceRecordSets"
            Resource:
              - !Join [ "/", [ 'arn:aws:route53:::hostedzone', !Ref 'HostedZone' ] ]
              - !Join [ "/", [ 'arn:aws:route53:::hostedzone', !Ref 'InternalHostedZone' ] ]
          - Effect: "Allow"
            Action:
              - "route53:ListHostedZones"
              - "route53:ListResourceRecordSets"
            Resource: "*"

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Name
        Value: 8y5ck
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    DependsOn:
      - PublicRouteTableEuCentral1a
      - PublicRouteTableEuCentral1b
      - PublicRouteTableEuCentral1c
    Properties:
      InternetGatewayId:
        Ref: InternetGateway
      VpcId: !Ref VPC
  PublicInternetGatewayRouteEuCentral1a:
    Type: AWS::EC2::Route
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTableEuCentral1a
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
  PublicInternetGatewayRouteEuCentral1b:
    Type: AWS::EC2::Route
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTableEuCentral1b
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
  PublicInternetGatewayRouteEuCentral1c:
    Type: AWS::EC2::Route
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTableEuCentral1c
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
  
  ApiInternalLoadBalancer:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      ConnectionSettings:
        IdleTimeout: 1200
      HealthCheck:
        HealthyThreshold: 2
        Interval: 5
        Target: TCP:443
        Timeout: 3
        UnhealthyThreshold: 2
      Listeners:
      
      - InstancePort: 443
        InstanceProtocol: TCP
        LoadBalancerPort: 443
        Protocol: TCP
      
      LoadBalancerName: 8y5ck-api-internal
      Scheme: internal
      SecurityGroups:
        - !Ref APIInternalELBSecurityGroup
      Subnets:
        - !Ref PrivateSubnetEuCentral1b
      
  ApiLoadBalancer:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      ConnectionSettings:
        IdleTimeout: 1200
      HealthCheck:
        HealthyThreshold: 2
        Interval: 5
        Target: TCP:443
        Timeout: 3
        UnhealthyThreshold: 2
      Listeners:
      
      - InstancePort: 443
        InstanceProtocol: TCP
        LoadBalancerPort: 443
        Protocol: TCP
      
      LoadBalancerName: 8y5ck-api
      Scheme: internet-facing
      SecurityGroups:
        - !Ref MasterSecurityGroup
      Subnets:
        - !Ref PublicSubnetEuCentral1a
      
        - !Ref PublicSubnetEuCentral1b
      
        - !Ref PublicSubnetEuCentral1c
      

  EtcdLoadBalancer:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      ConnectionSettings:
        IdleTimeout: 1200
      HealthCheck:
        HealthyThreshold: 2
        Interval: 5
        Target: TCP:2379
        Timeout: 3
        UnhealthyThreshold: 2
      Listeners:
      
      - InstancePort: 2379
        InstanceProtocol: TCP
        LoadBalancerPort: 2379
        Protocol: TCP
      
      LoadBalancerName: 8y5ck-etcd
      Scheme: internal
      SecurityGroups:
        - !Ref EtcdELBSecurityGroup
      Subnets:
        - !Ref PrivateSubnetEuCentral1b
      
  
  NATGatewayEuCentral1a:
    Type: AWS::EC2::NatGateway
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      AllocationId:
        Fn::GetAtt:
        - NATEIPEuCentral1a
        - AllocationId
      SubnetId: !Ref PublicSubnetEuCentral1a
      Tags:
        - Key: Name
          Value: 8y5ck
        - Key: giantswarm.io/availability-zone
          Value: eu-central-1a
  NATEIPEuCentral1a:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  NATGatewayEuCentral1b:
    Type: AWS::EC2::NatGateway
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      AllocationId:
        Fn::GetAtt:
        - NATEIPEuCentral1b
        - AllocationId
      SubnetId: !Ref PublicSubnetEuCentral1b
      Tags:
        - Key: Name
          Value: 8y5ck
        - Key: giantswarm.io/availability-zone
          Value: eu-central-1b
  NATEIPEuCentral1b:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  NATGatewayEuCentral1c:
    Type: AWS::EC2::NatGateway
    DependsOn:
      - VPCGatewayAttachment
    Properties:
      AllocationId:
        Fn::GetAtt:
        - NATEIPEuCentral1c
        - AllocationId
      SubnetId: !Ref PublicSubnetEuCentral1c
      Tags:
        - Key: Name
          Value: 8y5ck
        - Key: giantswarm.io/availability-zone
          Value: eu-central-1c
  NATEIPEuCentral1c:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  AWSCNINATRouteEuCentral1a:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref AWSCNIRouteTableEuCentral1a
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NATGatewayEuCentral1a
  NATRouteEuCentral1b:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableEuCentral1b
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NATGatewayEuCentral1b
  AWSCNINATRouteEuCentral1b:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref AWSCNIRouteTableEuCentral1b
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NATGatewayEuCentral1b
  AWSCNINATRouteEuCentral1c:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref AWSCNIRouteTableEuCentral1c
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: NATGatewayEuCentral1c
  HostedZone:
    Type: 'AWS::Route53::HostedZone'
    Properties:
      Name: '8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
  InternalHostedZone:
    Type: 'AWS::Route53::HostedZone'
    Properties:
      Name: '8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
      HostedZoneConfig:
        Comment: "Internal hosted zone for internal network"
      VPCs:
        - VPCId: !Ref VPC
          VPCRegion: 'eu-central-1'
  ApiRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      AliasTarget:
        DNSName: !GetAtt ApiLoadBalancer.DNSName
        HostedZoneId: !GetAtt ApiLoadBalancer.CanonicalHostedZoneNameID
        EvaluateTargetHealth: false
      Name: 'api.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
      HostedZoneId: !Ref 'HostedZone'
      Type: A
  ApiPublicInternalRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      AliasTarget:
        DNSName: !GetAtt ApiInternalLoadBalancer.DNSName
        HostedZoneId: !GetAtt ApiInternalLoadBalancer.CanonicalHostedZoneNameID
        EvaluateTargetHealth: false
      Name: 'internal-api.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
      HostedZoneId: !Ref 'HostedZone'
      Type: A
  ApiPrivateInternalRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      AliasTarget:
        DNSName: !GetAtt ApiInternalLoadBalancer.DNSName
        HostedZoneId: !GetAtt ApiInternalLoadBalancer.CanonicalHostedZoneNameID
        EvaluateTargetHealth: false
      Name: 'api.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
      HostedZoneId: !Ref 'InternalHostedZone'
      Type: A
  EtcdInternalRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      AliasTarget:
        DNSName: !GetAtt EtcdLoadBalancer.DNSName
        HostedZoneId: !GetAtt EtcdLoadBalancer.CanonicalHostedZoneNameID
        EvaluateTargetHealth: false
      Name: 'etcd.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
      HostedZoneId: !Ref 'InternalHostedZone'
      Type: A
  EtcdRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      AliasTarget:
        DNSName: !GetAtt EtcdLoadBalancer.DNSName
        HostedZoneId: !GetAtt EtcdLoadBalancer.CanonicalHostedZoneNameID
        EvaluateTargetHealth: false
      Name: 'etcd.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
      HostedZoneId: !Ref 'HostedZone'
      Type: A
  IngressWildcardRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: '*.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
      HostedZoneId: !Ref 'HostedZone'
      TTL: '300'
      Type: CNAME
      ResourceRecords:
        - 'ingress.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
  IngressWildcardInternalRecordSet:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: '*.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
      HostedZoneId: !Ref 'InternalHostedZone'
      TTL: '300'
      Type: CNAME
      ResourceRecords:
        - 'ingress.8y5ck.k8s.gauss.eu-central-1.aws.gigantic.io.'
  
  AWSCNIRouteTableEuCentral1a:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: 8y5ck-aws-cni
      - Key: giantswarm.io/availability-zone
        Value: eu-central-1a
      - Key: giantswarm.io/route-table-type
        Value: aws-cni
  AWSCNIRouteTableEuCentral1b:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: 8y5ck-aws-cni
      - Key: giantswarm.io/availability-zone
        Value: eu-central-1b
      - Key: giantswarm.io/route-table-type
        Value: aws-cni
  AWSCNIRouteTableEuCentral1c:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: 8y5ck-aws-cni
      - Key: giantswarm.io/availability-zone
        Value: eu-central-1c
      - Key: giantswarm.io/route-table-type
        Value: aws-cni
  PublicRouteTableEuCentral1a:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: 8y5ck-public
      - Key: giantswarm.io/availability-zone
        Value: eu-central-1a
      - Key: giantswarm.io/route-table-type
        Value: public
  PublicRouteTableEuCentral1b:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: 8y5ck-public
      - Key: giantswarm.io/availability-zone
        Value: eu-central-1b
      - Key: giantswarm.io/route-table-type
        Value: public
  PublicRouteTableEuCentral1c:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: 8y5ck-public
      - Key: giantswarm.io/availability-zone
        Value: eu-central-1c
      - Key: giantswarm.io/route-table-type
        Value: public
  PrivateRouteTableEuCentral1b:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
      - Key: Name
        Value: 8y5ck-private
      - Key: giantswarm.io/availability-zone
        Value: eu-central-1b
      - Key: giantswarm.io/route-table-type
        Value: private
  VPCPeeringRouteEuCentral1b:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableEuCentral1b
      DestinationCidrBlock: 10.1.0.0/16
      VpcPeeringConnectionId:
        Ref: VPCPeeringConnection
  MasterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 8y5ck-master
      VpcId: !Ref VPC
      SecurityGroupIngress:
      #
      # Public API Whitelist Disabled Rules
      #
      -
        Description: "Allow all traffic to the master instance."
        IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0

      -
        Description: "Allow traffic from Control Plane CIDR to 4194 for cadvisor scraping."
        IpProtocol: tcp
        FromPort: 4194
        ToPort: 4194
        CidrIp: 10.1.0.0/16
      -
        Description: "Allow traffic from Control Plane CIDR to 2379 for etcd backup."
        IpProtocol: tcp
        FromPort: 2379
        ToPort: 2379
        CidrIp: 10.1.0.0/16
      -
        Description: "Allow traffic from Control Plane CIDR to 10250 for kubelet scraping."
        IpProtocol: tcp
        FromPort: 10250
        ToPort: 10250
        CidrIp: 10.1.0.0/16
      -
        Description: "Allow traffic from Control Plane CIDR to 10300 for node-exporter scraping."
        IpProtocol: tcp
        FromPort: 10300
        ToPort: 10300
        CidrIp: 10.1.0.0/16
      -
        Description: "Allow traffic from Control Plane CIDR to 10301 for kube-state-metrics scraping."
        IpProtocol: tcp
        FromPort: 10301
        ToPort: 10301
        CidrIp: 10.1.0.0/16
      -
        Description: "Only allow SSH traffic from the Control Plane."
        IpProtocol: tcp
        FromPort: 22
        ToPort: 22
        CidrIp: 10.1.0.0/16

      Tags:
        - Key: Name
          Value: 8y5ck-master
  EtcdELBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 8y5ck-etcd-elb
      VpcId: !Ref VPC
      SecurityGroupIngress:
      -
        Description: "Allow all Etcd traffic from the VPC to the Etcd load balancer."
        IpProtocol: tcp
        FromPort: 2379
        ToPort: 2379
        CidrIp: 0.0.0.0/0
      -
        Description: "Allow traffic from Control Plane to Etcd port for backup and metrics."
        IpProtocol: tcp
        FromPort: 2379
        ToPort: 2379
        CidrIp: 10.1.0.0/16
      Tags:
        - Key: Name
          Value: 8y5ck-etcd-elb
  APIInternalELBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: 8y5ck-internal-api
      VpcId: !Ref VPC
      SecurityGroupIngress:
      #
      # Private API Whitelist Disabled Rules
      #
      -
        Description: "Allow all traffic to the master instance from A class network."
        IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: "10.0.0.0/8"
      -
        Description: "Allow all traffic to the master instance from B class network."
        IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: "172.16.0.0/12"
      -
        Description: "Allow all traffic to the master instance from C class network."
        IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: "192.168.0.0/16"

      Tags:
        - Key: Name
          Value: 8y5ck-internal-api
  AWSCNISecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "AWS CNI Security Group configured to the ENIConfig CRD."
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: 8y5ck-aws-cni
  PodsIngressRuleFromMAsters:
    Type: AWS::EC2::SecurityGroupIngress
    DependsOn: AWSCNISecurityGroup
    Properties:
      Description: Allow traffic from masters to pods.
      GroupId: !Ref AWSCNISecurityGroup
      IpProtocol: -1
      FromPort: -1
      ToPort: -1
      SourceSecurityGroupId: !Ref MasterSecurityGroup
  PodsAllowPodsCNIIngressRule:
    Type: AWS::EC2::SecurityGroupIngress
    DependsOn: AWSCNISecurityGroup
    Properties:
      Description: Allow traffic from pod to pod.
      GroupId: !Ref AWSCNISecurityGroup
      IpProtocol: -1
      FromPort: -1
      ToPort: -1
      SourceSecurityGroupId: !Ref AWSCNISecurityGroup
  MasterAllowCalicoIngressRule:
    Type: AWS::EC2::SecurityGroupIngress
    DependsOn: MasterSecurityGroup
    Properties:
      GroupId: !Ref MasterSecurityGroup
      IpProtocol: -1
      FromPort: -1
      ToPort: -1
      SourceSecurityGroupId: !Ref MasterSecurityGroup
  MasterAllowPodsCNIIngressRule:
      Type: AWS::EC2::SecurityGroupIngress
      DependsOn: MasterSecurityGroup
      Properties:
        Description: Allow traffic from pod to master.
        GroupId: !Ref MasterSecurityGroup
        IpProtocol: -1
        FromPort: -1
        ToPort: -1
        SourceSecurityGroupId: !Ref AWSCNISecurityGroup
  MasterAllowEtcdIngressRule:
    Type: AWS::EC2::SecurityGroupIngress
    DependsOn: MasterSecurityGroup
    Properties:
      GroupId: !Ref MasterSecurityGroup
      IpProtocol: "tcp"
      FromPort: 2379
      ToPort: 2379
      SourceSecurityGroupId: !Ref EtcdELBSecurityGroup
  VPCDefaultSecurityGroupEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      Description: Allow outbound traffic from loopback address.
      GroupId: !GetAtt VPC.DefaultSecurityGroup
      IpProtocol: -1
      CidrIp: 127.0.0.1/32
  
  AWSCNISubnetEuCentral1a:
    Type: AWS::EC2::Subnet
    DependsOn:
    - VPCCIDRBlockAWSCNI
    Properties:
      AvailabilityZone: eu-central-1a
      CidrBlock: <nil>
      Tags:
      - Key: Name
        Value: AWSCNISubnetEuCentral1a
      - Key: giantswarm.io/subnet-type
        Value: aws-cni
      VpcId: !Ref VPC
  AWSCNISubnetRouteTableAssociationEuCentral1a:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref AWSCNIRouteTableEuCentral1a
      SubnetId: !Ref AWSCNISubnetEuCentral1a
  AWSCNISubnetEuCentral1b:
    Type: AWS::EC2::Subnet
    DependsOn:
    - VPCCIDRBlockAWSCNI
    Properties:
      AvailabilityZone: eu-central-1b
      CidrBlock: <nil>
      Tags:
      - Key: Name
        Value: AWSCNISubnetEuCentral1b
      - Key: giantswarm.io/subnet-type
        Value: aws-cni
      VpcId: !Ref VPC
  AWSCNISubnetRouteTableAssociationEuCentral1b:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref AWSCNIRouteTableEuCentral1b
      SubnetId: !Ref AWSCNISubnetEuCentral1b
  AWSCNISubnetEuCentral1c:
    Type: AWS::EC2::Subnet
    DependsOn:
    - VPCCIDRBlockAWSCNI
    Properties:
      AvailabilityZone: eu-central-1c
      CidrBlock: <nil>
      Tags:
      - Key: Name
        Value: AWSCNISubnetEuCentral1c
      - Key: giantswarm.io/subnet-type
        Value: aws-cni
      VpcId: !Ref VPC
  AWSCNISubnetRouteTableAssociationEuCentral1c:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref AWSCNIRouteTableEuCentral1c
      SubnetId: !Ref AWSCNISubnetEuCentral1c
  PublicSubnetEuCentral1a:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: eu-central-1a
      CidrBlock: 10.100.3.32/27
      MapPublicIpOnLaunch: false
      Tags:
      - Key: Name
        Value: PublicSubnetEuCentral1a
      - Key: giantswarm.io/subnet-type
        Value: public
      - Key: kubernetes.io/role/elb
        Value: 1
      VpcId: !Ref VPC
  PublicSubnetRouteTableAssociationEuCentral1a:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTableEuCentral1a
      SubnetId: !Ref PublicSubnetEuCentral1a
  PublicSubnetEuCentral1b:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: eu-central-1b
      CidrBlock: 10.100.3.96/27
      MapPublicIpOnLaunch: false
      Tags:
      - Key: Name
        Value: PublicSubnetEuCentral1b
      - Key: giantswarm.io/subnet-type
        Value: public
      - Key: kubernetes.io/role/elb
        Value: 1
      VpcId: !Ref VPC
  PublicSubnetRouteTableAssociationEuCentral1b:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTableEuCentral1b
      SubnetId: !Ref PublicSubnetEuCentral1b
  PublicSubnetEuCentral1c:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: eu-central-1c
      CidrBlock: 10.100.3.160/27
      MapPublicIpOnLaunch: false
      Tags:
      - Key: Name
        Value: PublicSubnetEuCentral1c
      - Key: giantswarm.io/subnet-type
        Value: public
      - Key: kubernetes.io/role/elb
        Value: 1
      VpcId: !Ref VPC
  PublicSubnetRouteTableAssociationEuCentral1c:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTableEuCentral1c
      SubnetId: !Ref PublicSubnetEuCentral1c
  PrivateSubnetEuCentral1b:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: eu-central-1b
      CidrBlock: 10.100.3.64/27
      MapPublicIpOnLaunch: false
      Tags:
      - Key: Name
        Value: PrivateSubnetEuCentral1b
      - Key: giantswarm.io/subnet-type
        Value: private
      - Key: kubernetes.io/role/internal-elb
        Value: 1
      VpcId: !Ref VPC
  PrivateSubnetRouteTableAssociationEuCentral1b:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTableEuCentral1b
      SubnetId: !Ref PrivateSubnetEuCentral1b
  
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/24
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'
      Tags:
      - Key: Name
        Value: 8y5ck
  VPCCIDRBlockAWSCNI:
    Type: AWS::EC2::VPCCidrBlock
    DependsOn: VPCPeeringConnection
    Properties:
      CidrBlock: 172.17.0.1/16
      VpcId: !Ref VPC
  VPCPeeringConnection:
    Type: 'AWS::EC2::VPCPeeringConnection'
    Properties:
      VpcId: !Ref VPC
      PeerVpcId: vpc-testid
      # PeerOwnerId may be a number starting with 0. Cloud Formation is not able
      # to properly deal with that by its own so the configured value must be
      # quoted in order to ensure the peer owner id is properly handled as
      # string. Otherwise stack creation fails.
      PeerOwnerId: "control-plane-account"
      PeerRoleArn: peer-role-arn
  VPCS3Endpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcId: !Ref VPC
      RouteTableIds:
        - !Ref PublicRouteTableEuCentral1a
        - !Ref PublicRouteTableEuCentral1b
        - !Ref PublicRouteTableEuCentral1c
        - !Ref PrivateRouteTableEuCentral1b
      ServiceName: com.amazonaws.eu-central-1.s3
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "8y5ck-vpc-s3-endpoint-policy-bucket"
            Principal: "*"
            Effect: "Allow"
            Action: "s3:*"
            Resource: "arn:aws:s3:::*"
          - Sid: "8y5ck-vpc-s3-endpoint-policy-object"
            Principal : "*"
            Effect: "Allow"
            Action: "s3:*"
            Resource: "arn:aws:s3:::*/*"